<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuralHealth Analytics | OIE Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #020617; color: #f1f5f9; font-family: sans-serif; }
        .glass-card { background: rgba(15, 23, 42, 0.9); border: 1px solid #1e293b; border-radius: 12px; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="app" class="p-6 md:p-10 max-w-5xl mx-auto space-y-6">
        <header class="flex justify-between items-center border-b border-slate-800 pb-6">
            <h1 class="text-xl font-bold tracking-tighter italic text-white uppercase">NeuralHealth <span class="text-sky-500">Analytics</span></h1>
            <div id="status" class="text-[10px] font-mono text-sky-500 uppercase tracking-widest px-3 py-1 bg-slate-900 border border-slate-800 rounded">
                Initialising...
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="glass-card p-4 h-[500px] flex flex-col">
                <p class="text-[10px] text-slate-500 font-bold mb-4 uppercase tracking-widest">Region Selector</p>
                <div id="state-list" class="overflow-y-auto custom-scrollbar flex-grow pr-2"></div>
            </div>

            <div class="md:col-span-3 space-y-6">
                <div class="glass-card p-8">
                    <div class="flex justify-between items-end mb-8">
                        <div>
                            <h2 id="current-state" class="text-6xl font-black text-white">--</h2>
                            <p class="text-slate-500 text-xs font-bold uppercase mt-2">Efficiency Performance</p>
                        </div>
                        <div class="text-right">
                            <p id="op8-val" class="text-4xl font-black text-sky-400">0.0%</p>
                            <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest">OP-8 Score</p>
                        </div>
                    </div>
                    <div class="h-64"><canvas id="efficiencyChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let myChart = null;
        let allData = [];

        async function init() {
            const statusEl = document.getElementById('status');
            try {
                // Fetch with cache-busting
                const response = await fetch("./data.json?t=" + Date.now());
                if (!response.ok) throw new Error("File not found (404)");
                
                const raw = await response.json();
                
                // DATA DISCOVERY LOGIC: Find the array no matter where it's hidden
                let dataArray = Array.isArray(raw) ? raw : (raw.results || raw.data || Object.values(raw).find(Array.isArray));
                
                if (!dataArray || !Array.isArray(dataArray)) {
                    throw new Error("Invalid Data Format");
                }

                const processed = dataArray.reduce((acc, curr) => {
                    const state = curr.state;
                    if (!state || state.length !== 2) return acc;
                    if (!acc[state]) acc[state] = { state, op8: 0, op10: 0, op13: 0 };
                    const score = parseFloat(curr.score) || 0;
                    if (curr.measure_id === 'OP_8') acc[state].op8 = score;
                    return acc;
                }, {});

                allData = Object.values(processed).sort((a,b) => a.state.localeCompare(b.state));
                
                statusEl.innerText = "â— System Live";
                statusEl.className = statusEl.className.replace('text-sky-500', 'text-emerald-500');
                
                renderStateList();
                updateDashboard(allData[0]?.state || 'CA');
            } catch (err) {
                console.error("Dashboard Error:", err);
                statusEl.innerText = "Status: " + err.message;
                statusEl.className = statusEl.className.replace('text-sky-500', 'text-rose-500');
            }
        }

        function renderStateList() {
            const list = document.getElementById('state-list');
            list.innerHTML = "";
            allData.forEach(item => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left px-3 py-2 text-xs font-mono text-slate-500 hover:text-sky-400 hover:bg-slate-800 rounded mb-1";
                btn.innerText = item.state;
                btn.onclick = () => updateDashboard(item.state);
                list.appendChild(btn);
            });
        }

        function updateDashboard(stateCode) {
            const state = allData.find(s => s.state === stateCode);
            if (!state) return;
            document.getElementById('current-state').innerText = state.state;
            document.getElementById('op8-val').innerText = state.op8.toFixed(1) + '%';
            renderChart(stateCode);
        }

        function renderChart(activeState) {
            const ctx = document.getElementById('efficiencyChart').getContext('2d');
            const chartData = allData.slice(0, 15);
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(d => d.state),
                    datasets: [{
                        data: chartData.map(d => d.op8),
                        backgroundColor: chartData.map(d => d.state === activeState ? '#0ea5e9' : '#1e293b'),
                        borderRadius: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }
        init();
    </script>
</body>
</html>
