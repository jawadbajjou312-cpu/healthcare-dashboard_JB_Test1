<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare Efficiency Console</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>

    <style>
        body { background-color: #020617; color: #f1f5f9; font-family: sans-serif; }
        .glass-card { background: rgba(15, 23, 42, 0.9); border: 1px solid #1e293b; border-radius: 12px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Safety check to wait for libraries
        const init = () => {
            if (!window.React || !window.Recharts) {
                console.log("Waiting for libraries...");
                setTimeout(init, 100);
                return;
            }

            const { useState, useEffect } = window.React;
            const { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell } = window.Recharts;

            const App = () => {
                const [data, setData] = useState([]);
                const [selectedState, setSelectedState] = useState(null);

                useEffect(() => {
                    fetch("https://data.cms.gov/resource/if5v-4x48.json")
                        .then(res => res.json())
                        .then(json => {
                            const processed = json.reduce((acc, curr) => {
                                const state = curr.state;
                                if (!acc[state]) acc[state] = { state, op8: 0, op10: 0, op13: 0 };
                                const score = parseFloat(curr.score) || 0;
                                if (curr.measure_id === 'OP_8') acc[state].op8 = score;
                                if (curr.measure_id === 'OP_10') acc[state].op10 = score;
                                if (curr.measure_id === 'OP_13') acc[state].op13 = score;
                                return acc;
                            }, {});
                            const finalArray = Object.values(processed).filter(s => s.state && s.state.length === 2);
                            setData(finalArray);
                            setSelectedState(finalArray.find(s => s.state === 'CA') || finalArray[0]);
                        })
                        .catch(err => console.error("Fetch error:", err));
                }, []);

                if (!selectedState) return <div className="p-20 text-sky-500 mono">CONNECTING TO CMS...</div>;

                return (
                    <div className="p-10 max-w-5xl mx-auto space-y-6">
                        <div className="flex justify-between items-center border-b border-slate-800 pb-6">
                            <h1 className="text-xl font-bold tracking-tighter italic">NEURALHEALTH <span className="text-sky-500">ANALYTICS</span></h1>
                            <span className="text-xs font-mono text-emerald-500 uppercase tracking-widest">‚óè Live API Data</span>
                        </div>

                        <div className="glass-card p-8">
                            <div className="flex justify-between items-end mb-8">
                                <div>
                                    <h2 className="text-5xl font-black">{selectedState.state}</h2>
                                    <p className="text-slate-500 text-xs font-bold uppercase mt-2">Regional Efficiency Status</p>
                                </div>
                                <div className="text-right">
                                    <p className="text-4xl font-black text-sky-400">{selectedState.op8.toFixed(1)}%</p>
                                    <p className="text-[10px] text-slate-500 uppercase font-bold">OP-8 Efficiency</p>
                                </div>
                            </div>

                            <div className="h-64 w-full">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={data.slice(0, 12)}>
                                        <XAxis dataKey="state" stroke="#475569" fontSize={10} />
                                        <Tooltip contentStyle={{backgroundColor: '#020617', border: '1px solid #1e293b'}} />
                                        <Bar dataKey="op8">
                                            {data.slice(0, 12).map((entry, index) => (
                                                <Cell key={index} fill={entry.state === selectedState.state ? '#38bdf8' : '#1e293b'} />
                                            ))}
                                        </Bar>
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div className="glass-card p-4">
                                <p className="text-[10px] text-slate-500 font-bold uppercase mb-1">OP-10 Utilization</p>
                                <p className="text-2xl font-bold text-purple-400">{selectedState.op10.toFixed(1)}%</p>
                            </div>
                            <div className="glass-card p-4">
                                <p className="text-[10px] text-slate-500 font-bold uppercase mb-1">OP-13 Compliance</p>
                                <p className="text-2xl font-bold text-emerald-400">{selectedState.op13.toFixed(1)}%</p>
                            </div>
                        </div>
                    </div>
                );
            };

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        };

        init();
    </script>
</body>
</html>
