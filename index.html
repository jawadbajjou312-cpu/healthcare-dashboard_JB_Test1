<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare Efficiency Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #020617; color: #f1f5f9; font-family: sans-serif; }
        .glass-card { background: rgba(15, 23, 42, 0.9); border: 1px solid #1e293b; border-radius: 12px; }
    </style>
</head>
<body>
    <div id="app" class="p-6 md:p-10 max-w-5xl mx-auto space-y-6">
        <header class="flex justify-between items-center border-b border-slate-800 pb-6">
            <h1 class="text-xl font-bold tracking-tighter italic text-white">NEURALHEALTH <span class="text-sky-500">ANALYTICS</span></h1>
            <div id="status" class="text-[10px] font-mono text-sky-500 uppercase tracking-widest">Connecting to CMS API...</div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="glass-card p-4 h-96 overflow-y-auto" id="state-list">
                <p class="text-[10px] text-slate-500 font-bold mb-4 uppercase">Select State</p>
                </div>

            <div class="md:col-span-3 space-y-6">
                <div class="glass-card p-8">
                    <div class="flex justify-between items-end mb-8">
                        <div>
                            <h2 id="current-state" class="text-6xl font-black text-white">--</h2>
                            <p class="text-slate-500 text-xs font-bold uppercase mt-2">Regional Efficiency Matrix</p>
                        </div>
                        <div class="text-right">
                            <p id="op8-val" class="text-4xl font-black text-sky-400">0.0%</p>
                            <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest">OP-8 Efficiency</p>
                        </div>
                    </div>
                    <div class="h-64">
                        <canvas id="efficiencyChart"></canvas>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="glass-card p-6">
                        <p class="text-[10px] text-slate-500 font-bold uppercase mb-1">OP-10 Utilization</p>
                        <p id="op10-val" class="text-2xl font-bold text-purple-400">0.0%</p>
                    </div>
                    <div class="glass-card p-6">
                        <p class="text-[10px] text-slate-500 font-bold uppercase mb-1">OP-13 Compliance</p>
                        <p id="op13-val" class="text-2xl font-bold text-emerald-400">0.0%</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let myChart = null;
        let allData = [];

        async function init() {
            try {
                const response = await fetch("https://data.cms.gov/resource/if5v-4x48.json");
                const json = await response.json();
                
                // Process data
                const processed = json.reduce((acc, curr) => {
                    const state = curr.state;
                    if (!state || state.length !== 2) return acc;
                    if (!acc[state]) acc[state] = { state, op8: 0, op10: 0, op13: 0 };
                    const score = parseFloat(curr.score) || 0;
                    if (curr.measure_id === 'OP_8') acc[state].op8 = score;
                    if (curr.measure_id === 'OP_10') acc[state].op10 = score;
                    if (curr.measure_id === 'OP_13') acc[state].op13 = score;
                    return acc;
                }, {});

                allData = Object.values(processed).sort((a,b) => a.state.localeCompare(b.state));
                
                document.getElementById('status').innerText = "â— System Live";
                document.getElementById('status').classList.replace('text-sky-500', 'text-emerald-500');
                
                renderStateList();
                updateDashboard('CA'); // Default
            } catch (err) {
                document.getElementById('status').innerText = "API Error: " + err.message;
                document.getElementById('status').classList.replace('text-sky-500', 'text-rose-500');
            }
        }

        function renderStateList() {
            const list = document.getElementById('state-list');
            allData.forEach(item => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-2 text-sm text-slate-400 hover:text-white hover:bg-slate-800 rounded transition mb-1 font-mono";
                btn.innerText = item.state;
                btn.onclick = () => updateDashboard(item.state);
                list.appendChild(btn);
            });
        }

        function updateDashboard(stateCode) {
            const state = allData.find(s => s.state === stateCode);
            if (!state) return;

            document.getElementById('current-state').innerText = state.state;
            document.getElementById('op8-val').innerText = state.op8.toFixed(1) + '%';
            document.getElementById('op10-val').innerText = state.op10.toFixed(1) + '%';
            document.getElementById('op13-val').innerText = state.op13.toFixed(1) + '%';

            renderChart(stateCode);
        }

        function renderChart(activeState) {
            const ctx = document.getElementById('efficiencyChart').getContext('2d');
            const chartData = allData.slice(0, 15);
            
            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(d => d.state),
                    datasets: [{
                        data: chartData.map(d => d.op8),
                        backgroundColor: chartData.map(d => d.state === activeState ? '#38bdf8' : '#1e293b'),
                        borderColor: '#334155',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#1e293b' }, ticks: { color: '#475569' } },
                        x: { grid: { display: false }, ticks: { color: '#475569' } }
                    }
                }
            });
        }

        init();
    </script>
</body>
</html>
